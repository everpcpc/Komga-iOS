name: release

on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  detect:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.current }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect project version changes
        id: changed-files
        uses: tj-actions/changed-files@v45
        with:
          files: |
            KMReader.xcodeproj/project.pbxproj

      - name: Read marketing version
        id: version
        if: steps.changed-files.outputs.any_changed == 'true'
        run: |
          set -euo pipefail
          FILE="KMReader.xcodeproj/project.pbxproj"
          if [ ! -f "$FILE" ]; then
            echo "project.pbxproj not found at $FILE" >&2
            exit 1
          fi
          VERSION=$(awk 'match($0,/MARKETING_VERSION = ([^;]+);/,a){gsub(/"/,"",a[1]); print a[1]; exit}' "$FILE")
          if [ -z "$VERSION" ]; then
            echo "MARKETING_VERSION not found in $FILE" >&2
            exit 1
          fi
          echo "Detected MARKETING_VERSION: $VERSION"
          echo "current=$VERSION" >> "$GITHUB_OUTPUT"

      - name: No project change affecting marketing version
        if: steps.changed-files.outputs.any_changed != 'true'
        run: |
          echo "KMReader.xcodeproj/project.pbxproj did not change; skipping release."

  create:
    runs-on: ubuntu-latest
    needs: detect
    if: needs.detect.outputs.version
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create GitHub release
        env:
          GH_TOKEN: ${{ github.token }}
          VERSION: ${{ needs.detect.outputs.version }}
        run: |
          set -euo pipefail
          TAG="v${VERSION}"
          if gh release view "$TAG" >/dev/null 2>&1; then
            echo "Release $TAG already exists, skipping creation."
          else
            # Check version format: X.Y (stable) vs X.Y.Z (prerelease)
            if echo "$VERSION" | grep -qE '^[0-9]+\.[0-9]+$'; then
              echo "Creating stable release: $TAG"
              gh release create "$TAG" --target "$GITHUB_SHA" --title "$TAG" --generate-notes
            else
              echo "Creating prerelease: $TAG"
              gh release create "$TAG" --target "$GITHUB_SHA" --title "$TAG" --generate-notes --prerelease
            fi
          fi

  build:
    runs-on: macos-latest
    needs: [detect, create]
    if: needs.detect.outputs.version
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: "latest-stable"

      - name: Prepare App Store Connect API key
        id: prepare
        env:
          APP_STORE_CONNECT_API_PRIVATE_KEY: ${{ secrets.APP_STORE_CONNECT_API_PRIVATE_KEY }}
        run: |
          set -euo pipefail
          if [ -z "${APP_STORE_CONNECT_API_PRIVATE_KEY}" ]; then
            echo "APP_STORE_CONNECT_API_PRIVATE_KEY is not set." >&2
            exit 1
          fi
          umask 077
          KEY_PATH="$RUNNER_TEMP/appstoreconnect_key.p8"
          printf "%s" "$APP_STORE_CONNECT_API_PRIVATE_KEY" > "$KEY_PATH"
          echo "APP_STORE_CONNECT_API_KEY_PATH=$KEY_PATH" >> "$GITHUB_OUTPUT"

      - name: Import codesign certs
        uses: apple-actions/import-codesign-certs@v3
        with:
          p12-file-base64: ${{ secrets.APPSTORE_CERTIFICATES_FILE_BASE64 }}
          p12-password: ${{ secrets.APPSTORE_CERTIFICATES_PASSWORD }}

      - name: Import provisioning profiles
        run: misc/import_profiles.sh
        env:
          IOS_PROVISIONING_PROFILE_BASE64: ${{ secrets.IOS_PROVISIONING_PROFILE_BASE64 || '' }}
          MACOS_PROVISIONING_PROFILE_BASE64: ${{ secrets.MACOS_PROVISIONING_PROFILE_BASE64 || '' }}
          TVOS_PROVISIONING_PROFILE_BASE64: ${{ secrets.TVOS_PROVISIONING_PROFILE_BASE64 || '' }}

      - name: Verify certificates and profiles
        run: |
          set -euo pipefail

          # List available certificates for debugging
          echo "Available signing certificates:"
          security find-identity -v -p codesigning | grep "Apple Distribution" || echo "No Apple Distribution certificate found"

          # List imported provisioning profiles
          PROFILES_DIR="$HOME/Library/MobileDevice/Provisioning Profiles"
          echo ""
          echo "Available provisioning profiles:"
          ls -lh "$PROFILES_DIR" 2>/dev/null | tail -n +2 || echo "No profiles found"

          echo ""
          echo "xcodebuild will automatically select the appropriate certificate and provisioning profile"

      - name: Run make release
        env:
          APP_STORE_CONNECT_API_KEY_PATH: ${{ steps.prepare.outputs.APP_STORE_CONNECT_API_KEY_PATH }}
          APP_STORE_CONNECT_API_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_API_ISSUER_ID }}
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
        run: make release

      - name: Run make artifacts
        run: make artifacts

      - name: Upload release artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-artifacts
          path: artifacts/*
          retention-days: 1

  publish:
    runs-on: ubuntu-latest
    needs: [detect, create, build]
    if: needs.detect.outputs.version
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download release artifacts
        uses: actions/download-artifact@v4
        with:
          name: release-artifacts
          path: artifacts

      - name: Upload to GitHub Release
        env:
          GH_TOKEN: ${{ github.token }}
          VERSION: ${{ needs.detect.outputs.version }}
        run: |
          set -euo pipefail
          TAG="v${VERSION}"

          # Find all .ipa and .dmg files (already prepared with platform identifiers)
          ARTIFACTS=$(find artifacts -type f \( -name "*.ipa" -o -name "*.dmg" \) | sort)

          if [ -z "$ARTIFACTS" ]; then
            echo "No artifacts found"
            ls -la artifacts/ || true
            exit 1
          fi

          echo "Found artifacts (already prepared with platform identifiers):"
          echo "$ARTIFACTS"
          echo ""

          # Upload each artifact to GitHub Release
          for artifact in $ARTIFACTS; do
            echo "Uploading: $(basename "$artifact")"
            gh release upload "$TAG" "$artifact" --clobber
          done
